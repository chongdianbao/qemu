name: Build QEMU aarch64-static

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ninja-build \
          pkg-config \
          libglib2.0-dev \
          libpixman-1-dev \
          libfdt-dev \
          libslirp-dev \
          zlib1g-dev \
          libmount-dev \
          python3-pip \
          python3-venv \
          flex \
          bison

    - name: Install additional Python packages
      run: |
        pip3 install tomli

    - name: Configure QEMU
      run: |
        mkdir -p build
        cd build
        ../configure \
          --target-list=aarch64-softmmu \
          --static \
          --disable-docs \
          --disable-tools \
          --disable-guest-agent \
          --disable-gtk \
          --disable-sdl \
          --disable-vnc \
          --disable-spice \
          --disable-xen \
          --disable-kvm \
          --disable-user \
          --disable-linux-user \
          --disable-bsd-user \
          --disable-plugins \
          --disable-brlapi \
          --disable-rdma \
          --disable-libiscsi \
          --disable-libnfs \
          --disable-libssh \
          --disable-rbd \
          --disable-lzo \
          --disable-snappy \
          --disable-bzip2 \
          --disable-seccomp \
          --disable-glusterfs \
          --disable-libusb \
          --disable-usb-redir \
          --disable-smartcard \
          --disable-libpmem \
          --disable-libdaxctl \
          --disable-alsa \
          --disable-pa \
          --disable-oss \
          --disable-dsound \
          --disable-sndio \
          --disable-vde \
          --disable-netmap \
          --disable-curses \
          --disable-iconv \
          --disable-curl \
          --disable-vhost-net \
          --disable-vhost-crypto \
          --disable-vhost-user \
          --disable-vhost-kernel \
          --disable-qom-cast-debug \
          --disable-bochs \
          --disable-cloop \
          --disable-dmg \
          --disable-qcow1 \
          --disable-vdi \
          --disable-vvfat \
          --disable-qed \
          --disable-parallels \
          --disable-capstone \
          --disable-zstd \
          --disable-linux-io-uring \
          --disable-xkbcommon \
          --disable-werror

    - name: Build QEMU
      run: |
        cd build
        make -j$(nproc)

    - name: Check binary
      run: |
        file build/qemu-system-aarch64
        ldd build/qemu-system-aarch64 2>/dev/null || echo "Static binary (no dynamic dependencies)"
        ls -lh build/qemu-system-aarch64

    - name: Create tarball
      run: |
        cd build
        tar czvf qemu-system-aarch64-static.tar.gz qemu-system-aarch64
        mv qemu-system-aarch64-static.tar.gz ../

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: qemu-system-aarch64-static
        path: qemu-system-aarch64-static.tar.gz

    - name: Create Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: qemu-system-aarch64-static.tar.gz
        name: QEMU aarch64-static ${{ github.ref_name }}
        body: |
          Static build of QEMU system emulator for aarch64 target.
          
          Includes CAN device fixes for kvaser_pci device reset on guest reboot.
          
          Build configuration:
          - Target: aarch64-softmmu
          - Static linking enabled
          - CAN support (kvaser_pci) included
          - TCG (Tiny Code Generator) enabled
          
          Usage:
          ```bash
          tar xzvf qemu-system-aarch64-static.tar.gz
          ./qemu-system-aarch64 --help
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
